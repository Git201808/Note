# 第8章 互联网上的音频/视频服务

## 8.1 概述

- 计算机网络最初是为传送数据信息设计的，互联网IP层提供的“尽最大努力交付”服务，以及每一个分组独立交付的策略，对传送数据信息也是很合适的。
- 互联网使用的TCP协议可以很好的解决网络不能提供可靠交付这一问题。

### 多媒体信息的特点

- 多媒体信息（包括声音和图像信息）与不包括声音和图像的数据信息有很大的区别。
- 1，多媒体信息的信息量往往很大。
- 2，在传输多媒体数据时，对时延和时延抖动均有较高的要求。
- 3，多媒体数据往往是**实时数据**（real tine data）,它的含义是：在发送实时数据的同时，在接收端边接收，边播放。

### 互联网是非等时的

- 模拟的多媒体信号经过采样和模数转换变为数字信号，再组装成分组。这些分组的发送速率是**恒定的**（等时的）。

### 在接收端设置缓存

- 要解决非等时问题，接收端需设置适当大小的缓存。当缓存中的分组数达到一定的数量后再以恒定速率按顺序把分组读出进行还原播放。
- 缓存实际上就是一个先进先出的队列。标明的T叫做**播放时延**。

### 缓存的影响

- 缓存使所有到达的分组都经受了迟延。
- 早到达的分组在缓存中停留的时间较长，而晚到达的分组在缓存中停留的时间则较短。
- 以非恒定速率到达的分组，经过缓存后再以恒定速率读出，就能够在一定程度上消除了时延的**抖动**。但我们付出的代价是**增加了时延**

### 需要解决的问题

- 在传送**时延敏感**(dalay sensitive)的实时数据时，不仅**传输时延**太大，而且**时延抖动**也必须受到限制。
- 对于传送实时数据，很少量分组的**丢失**对播放效果的影响并不大（因为这是由人来进行主观评价的），因而是可以容忍的。
- **丢失容忍**(loss tolerant)也是实时数据的另一个重要特点。
- 由于分组的到达可能不排序，但将分组还原和播放时又应当是按序的，因此在发送多媒体分组时还应当给每一个分组加上**序号**。这表明还应当有相应的协议支持才行。
- 要使接收端能够将节目本来就存在的正常的短时间停顿（如音乐中停顿几拍）和因某些分组的较大迟延造成的“停顿”区分开来，就需要增加一个**时间戳**(timestamp)，以便告诉接收端应当在什么时间播放哪个分组。

### 必须改造现有的互联网

- **大量使用光缆和高速路由器**，网络的时延和时延抖动就可以足够小，在互联网长传送实时数据就不会有问题。
- 把互联网改造为能够对端到端的带宽实现预留(reservation)，把使用无线连接协议的互联网转变为面向连接的网络。
- 部分改动互联网的协议栈所付出的代价较小，而这也能够使多媒体信息在互联网上传输质量得到改进。

### 互联网提供的音频/视频服务类型

目前互联网提供的音频/视频服务大体可分为三种类型：

- **流式(streaming)存储音频/视频**——边下载边播放。
- **流式实况音频/视频**——边录制边发送。
- **交互式音频/视频**——实时交互式通信。

#### “边下载边播放”中的“下载”

- 对于流式音频/视频的“下载”，实际上并没有把“下载”的内容存储在硬盘上。
- “边下载编播放”结束后，用用户的硬盘上没有留下有关播放内容的任何痕迹。
- **流媒体**(streaming media)即流式音频/视频。
- **流媒体特点就是“边下载边播放”**(streaming and playing)。

## 8.2 流式存储音频/视频

### 流览器从服务器下载音频/视频文件步骤

1. 用户从客户机(client machile)的浏览器上用HTTP协议向服务器**请求下载**某个音频/视频文件。
2. 服务器如有此文件就发送给浏览器。在响应报文中就装有用户所要的音频/视频文件。整个下载过程可能会**花费很长的时间**。
3. 当浏览器**完全收下**这个文件后，就可以传送给自己的机器上的媒体播放器进行解压缩，然后播放。

### 8.2.1 具有元文件的万维网服务器

- **元文件**就是一种非常小的文件，它描述或指明其他文件的一些重要信息。这里的元文件保存了有关这个音频/视频文件的信息。

#### 使用元文件下载音频/视频文件

1. 浏览器用户使用HTTP的GET报文接入到万维网服务器。这个超链接指向一个元文件。这个元文件是实际的音频/视频文件的统一资源定位符URL。
2. 万维网服务器把该元文件装入HTTP响应报文的主体，发回给浏览器。
3. 客户机浏览器调用相关的媒体播放器，把提取出的元文件传送给媒体播放器。
4. 媒体播放器使用元文件中URL，向万维网服务器发送HTTP请求报文，要求下载音频/视频文件。
5. 万维网服务器发送HTTP响应报文，把音频/视频文件发送给媒体播放器。媒体播放器边下载边解压缩边播放。

### 8.2.2 媒体服务器

- **媒体播放器**也称为**流式服务器**(streaming server),它支持流式音频和视频的传送。
- 媒体播放器与媒体服务器的关系是**客户与服务器的关系**。
- 媒体播放器不是向万维网服务器而是向媒体服务器请求音频/视频文件。
- 媒体服务器和媒体播放器之间采用了**另外的协议**进行交互。

#### 使用媒体服务器下载音频/视频的步骤

1-3 三个步骤仍然和使用元文件下载一样。区别就是后面两个步骤。

4. 媒体播放器使用元文件中URL接入到媒体服务器，请求下载浏览器所请求的音频/视频文件。下载可以借助于使用UDP的任何协议，例如使用实时运输协议RTP。
5. 媒体服务器给出响应，把该音频/视频文件发送给媒体播放器。媒体播放器在迟延了若干秒后，以流的形式边下载边解压缩编播放。

#### 使用TCP，还是UDP？

- 传送音频/视频文件可以使用TCP，也可以使用UDP。起初人们选用UDP来传送。

- 采用UDP会有以下几个缺点。

  - 由于网络的情况多变，在接收端的播放器很难做到始终按规定的速率播放。

  - 很多单位的防火墙往往阻拦外部UDP分组的进入，因而使用UDP传送流式多媒体文件时会被防火墙阻拦掉。
  - 使用UDP传送流式多媒体文件时，如果在用户端希望能够控制媒体的播放，如进行暂停、快进等操作，那么还需要使用另外的协议RTP和RTSP，增加了成本和复杂性。

- 现在对流式存储音频/视频的播放，如YouTubeh和Netflix，都是采用TCP来传送。

#### 使用TCP传送流式视频主要步骤

1. 用户使用HTTP获取存储在万维网服务器中的视频文件然后把视频数据传送到TCP发送缓存中。若发送缓存已填满，就暂时停止传送。
2. 从TCP发送缓存通过互联网向客户机中的TCP接收缓存传送视频数据，直到接收缓存被填满。
3. 从TCP接收缓存把视频数据再传送到应用程序缓存（即媒体播放器的缓存）。当这个缓存中的视频存储到一定程度时，就开始播放。 这个过程一般不超过1分钟。
4. 在播放时，媒体播放器等时的（即周期性地）把视频数据按帧读出，经解压缩后，把视频节目显示在用户的屏幕上。

### 8.2.3 实时流式协议RTSP

- RTSP(Real-Time Streaming Protocol)协议以**客户服务器方式**工作。它本身并不传送数据，是一个多媒体播放**控制协议**，用来使用用户在播放从互联网下载的实时数据时能够进行控制，如：暂停/继续、后退、前进等。因此RTSP又称为“**互联网录像机遥控协议**”。
- 要实现RTSP的控制功能，我们不仅要有协议，而且要有专门的**媒体播放器**(media player)和**媒体服务器**(media server)。

#### RTSP特点

- RTSP是有状态的协议。它记录客户机所处于的状态(初始化状态、播放状态或暂停状态)
- RTSP控制分组即可在TCP上传送，也可在UDP上传送。
- RTSP没有定义音频/视频的压缩方案，也没有规定音频/视频在网络中传送时应如何封装在分组中。
- RTSP没有规定音频/视频流在媒体播放器中应如何缓存。

#### 使用RTSP的媒体服务器个工作过程

1. 浏览器向万维网服务器请求音频/视频文件。
2. 万维网服务器从浏览器发送携带有元文件的响应。
3. 浏览器把收到的元文件传送给媒体播放器。
4. RTSP客户与媒体服务器的RTSP服务器建立连接。
5. RSTP服务器发送响应RESPONSE报文。
6. RSTP客户发送PLAY报文，开始下载音频/视频文件。
7. RTSP服务器发送响应RSPONSE报文。
8. RTSP客户发送TEARDOWN报文断开连接。
9. RTSP服务器发送响应RESPONSE报文。

## 8.3 交互式音频/视频

#### 8.3.1 IP电话概述

##### 1. 狭义的和广义的IP电话

- **狭义的IP电话**就是指在IP网络上打电话。所谓“IP网络“就是”使用IP协议的分组交换网“的简称。
- **广义的IP电话**则不仅仅是电话通信，而且还可以是在IP网络上进行交互式多媒体实时通信（包括话音、视像等），甚至还包括**即时传信**IM(Instant Messaging)。

#### 2. IP电话网关

- 20世纪90年代中期，VocalTec公司率先推出了实用化的IP电话。但是这种IP电话必须使用PC。

- 1996年3月，VocalTec公司成功推出了IP电化网关(IP Telephony Gateway)，它是公用电话网与IP网络的接口设备。

- IP电话网关的作用就是：

  - (1) 在电话呼叫阶段和呼叫释放解段进行电话信令的转换。

  - (2) 在通话期间进行话音编码的转换。

#### 3. IP电话的通话质量

- IP电话的通话质量主要由两个因素决定：
  - 一个是通话双方端对端的时延和时延抖动;
  - 另一个是话音分组的丢失率。
- 但这两个因素是不确定的，取决于当时网络上 的通信量
- 经验证明，在电话交谈中，端对端的时延不应超过250ms，否则交谈者就能感到不自然。

#### IP电话的端到端时延

(1) 话音信号进行模数转化要经受时延。

(2) 话音比特流装配成话音分组的时延。

(3) 话音分组的发送需要时间，此时间等于话音分组长度与通信线路的数据率之比。

(4) 话音分组在因特网中的存储转变时延。

(5) 话音分组在接收端缓存中暂存所引起的时延。

(6) 话音分组还原成模拟话音信号的时延。

(7) 话音信号在通信线路上的传播时延。

(8) 终端设备的硬件和操做系统产生的接入时延。

#### 先速路由器

- **提高路由器的转发分组的速率**对提高IP电话的质量也是很重要的。
- 据统计，一个跨大西洋的IP电化一般要经过20~30个路由器。
- 若能改用吉比特路由器(又称为线速路由器)，则每秒可转发5百万至6千万个分组(即交换速率达60Gbit/s左右)。这样还可进一步减少有网络造成的时延。

#### 关于Skype

- **Skype采以用了P2P和全球索引技术**提供快速路由选择机制，管理成本大大降低。由于用户路由信息分布式存储与因特网的结点中，因此呼叫连接完成得很快。
- Skype采用了**端对端加密方式**，保证信息的安全性。
- Skype使用了P2P的技术，用户数据主要存储在P2P网络中，因此必须保证存储在公共网络中的数据是可靠的和没有被篡改的。Skype对公共目录中存储的和用户相关的数据都采用了数字签名，保证了数据无法被篡改。
- Skype的问世给全球信息技术和通信产业带来深远的影响，也给每一位网络使用者带来生或方式的改变。

#### 8.3.2 IP电话所需要的几种应用协议

- 在IP电话的通信中，至少需要两种应用协议：
  - 一种是**信令协议**，它使我们能够在互联网上找到被叫用户。
  - 另一种是话音分组的**传送协议**，它使我们用来进行电话通信的话音数据能够以时延敏感属性的互联网中传送。
- 为了在互联网中提供实时交互式的音频/视频服务，我们需要新的多媒体体系结构。

#### 8.3.3 实时运输协议RTP 

- **实时运输协议RTP**(Real-time Transport Protocol)为实时应用提供端到端的运输，但不提供任何服务质量的保证。
- 多媒体数据块经压缩编码处理后，先送给RTP封装成为RTP分组，再装入运输层的UDP用户数据报，然后再交给IP层。
- RTP是一个协议框架，只包含了实时应用的一些共同的功能。
- RTP自己并不对多媒体数据块做任何处理，而只是向应用层提供一些附加的信息，让应用层知道应当如何进行处理。

##### RTP的层次

- 从应用开发者的角度看，RTP应当是应用层的一部分。
- 在应用的发送端，开发者 必须编写用RTP封装分组的程序代码，然后把RTP分组交给UDP插口接口。
- 在接收端，RTP分组通过UDP插口接口进入应用层后，还要利用开发者编写的称序代码从RTP分组中把应用数据块提取出来。

##### RTP也可看成运输层的一个子层

- RTP封装了多媒体应用的数据块。
- 由于RTP向多媒体应用称序 提供了服务（如时间 和序号），因此也可以将RTP看成是在UDP之上的一个运输层的子层。

#### 8.3.4 实时运输控制协议RTCP

- RTCP(RTP Control Protocol)是**与RTP配合使用**的协议。
- RTCP协议的**主要功能**：
  - 服务质量的监视与反馈;
  - 媒体间的同步;
  - 播组中成员的标识。
- RTCP分组也**使用了UDP传送**，但RTCP并不对声音或视像分组进行封装。
- 可将多个RTCP分组封装在一个UDP用户数据报中。

##### RTCP使用的五种分组类型

- **结束分组BYE**表示关闭一个数据流
- **特定应用分组APP**使应用程序能够定义新的分组类型。
- **接收端报告分组RR**用来使接收端周期性地向所有的点用多播方式进行报告。
- **发送端报告分组SR**用来使发送端周期性地向所有接收端用多播方式进行报告。
- **源点描述分组SDES**给出会话中参加者的描述。

#### 8.3.5 H.323

- H.323是ITU-T1996年制订的一个名称很长的建议书，1998年的第二个版本改用的名称是“**基于分组的多媒体通信系统**”。
- H.323包括系统和构件的描述，呼叫模型的描述，呼叫信令过程，控制报文，复用，话音编解码器，视像编解码器，以及数据协议等，但**不保证服务质量QoS**。

#### H.323标准指明的四种构件

(1) **H.323终端**

(2) **网关**——网关连接到两种不同的网络，使H.323网络可以和非H.323网络进行通信。

(3) **网闸(gatekeeper)**——所有的呼叫都要通过网闸，因为网闸提供地址转换、授权、带宽管理和计费功能。

(4) 多点控制单元mcu(Multipoint Contril Unit)——MCU支持三个或更多的H.323终端的音频或视频会议。

#### 8.3.6 会话发起协议SIP

- H.323过与复杂，不便于发展基于IP的新业务。
- SIP(Session Initiation Protocol)是一套较为简单实用的标准，目前已成为互联网的建议标准。
- SIP协议以互联网为基础，把IP电话视为互联网上的新应用。
- SIP协议只涉及到IP电话的信令和有关服务质量问题，而没有提供像H.323那样多的功能。

#### SIP系统的构件

- SIP使用文本方式的**客户服务器协议**。
- SIP系统的两种构件是**用户代理**和**网络服务器**。
- **用户代理**包括**用户代理客户**和**用户代理服务器**，前者用来发起呼叫，而后者用来接受呼叫。
  - 代理服务器接受来自主叫用户的呼叫请求，并将其转发给下一跳代理服务器，最后将呼叫请求转发给被叫用户。
  - 重定向服务器不接受呼叫，它通过响应告诉客户下一跳代理服务器的地址，由客户按此地址向下一跳代理服务器重新发送呼叫请求。

#### 会话描述协议SDP

- SDP(Session Description Protocol)在电话会议的情况下特别重要，因为电话会议的参加者是动态的加入和退出。
- SDP详细的指明了媒体编码、协议的端口号以及多播地址。
- SDP现在也是互联网建议标准。



## 8.4 改进“尽最大努力交付“的服务

- 8.4.1 使互联网提供服务质量
  - **服务质量QoS**是服务性能的总效果，此效果决定了一个用户对服务的满意称度。因此在最简单的意义上，有服务质量的服务就是满足用户的应用需求的服务。
  - 服务质量可用若干**基本的性能指标**来描述，包括：可用性、差错率、响应时间、吞吐量、分组丢失率、连接建立时间、故障检测和改正时间等。
  - 服务提供者可向其用户保证某一种等级的服务质量。
- 8.4.2 调度和管理机制
- 8.4.3 综合服务IntServ与资源预留协议RSVP
- 8.4.4 区分服务 DiffSery

### 8.4.2 调度和管理机制

#### 1.  调度机制

- “**调度**” 就是指排队的规则。
- 如不采用专门的调度的机制，则默认排队规则就是**先进先出**FIFO(First In First Out)。当队列已满时，后到达的分组就被丢弃。
- **先进先出的最大缺点是**：不能区分时间敏感分组和一般数据分组，并且也不公平。
- 在先进先出的基础上**增加按优先级排队**，就能使优先级高的分组优先得到服务。

#### 2. 管制机制
(1)**平均速率** 网络需要控制一个数据流的平均速率。 这里的平均速率是指**一定的时间间隔内**通过的分组数。
(2) **峰值速率** 峰值速率限制了数据流在**非常短的时间间隔内**的流量。

#### 8.4.3 综合服务 IntServ 与资源预留协议RSVP

- **综合服务**IntServ(Integrated Services)可对单个的应用会话提供服务的质量保证，其主要特点有2个：
  - **资源预留**。路由器需要知道不断出现的会话已预留了多少资源(即链路带宽和缓存空间)。
  - **呼叫建立**。需要服务质量保证的会话必须首先在源站到目的站的路径上的每个路由器预留足够的资源，以保证其端到端的服务质量要求。

#### IntServ定义了两类服务

- **有保证的服务**(guaranteed service)可保证一个分组在通过路由器时的排队时延有一个严格的上限
- **受控负载的服务**(controlled-load service)可以使应用程序得到比通常的“尽最大努力”更加可靠的服务。

##### IntServ由四个组成部分

(1) **资源预留协议RSVP**，它是IntServ的信令协议。

(2) **接纳控制**(adminssion control)，用来决定是否同意对某一资源的请求。

(3) **分类器**(classifier),用来将进入路由器的分组进行分类，并根据分类的结果将不同类别的分组放入特定的队列。

(4) **调度器**(scheduler),根据服务质量要求决定分组发送的前后顺序。

#### 流(flow)

- "流"是在多媒体通信中的一个常用的名词，一般定义为：

  **具有同样的源IP地址、源端口号、目的IP地址、目的端口号、协议标识符以及服务质两需求的一连串分组。**

#### 资源预留协议RSVP

- 一个会话必须首先声明它所需的服务质量，以便使路由器能够确定是否有足够的资源来满足该会话的需求。
- 当请求被接受时，链路带宽和缓存空间就被分配给这个分组流。
- 资源预留协议RSVP在进行资源预留时采用了多播树的方式。

#### IntServ体系结构在路由器中的实现

- IntServ/RSVP所基于的概念是端系统中与分组流有关的状态信息。各路由器中的预留信息只存储有限的时间(这称为软状态soft-state)，因而各终点对这些与留信息必须定期进行更新。
- 还应注意到，RSVP协议不是运输层协议而是个网络层的控制协议。
- RSVP不携带应用数据。

##### 综合服务IntServ体系结构存在的主要问题

(1) 状态信息的数据与流的数目**成正比**。因此在大型网络中，按每个进行资源预留会产生很大的开销。

(2) IntServ体系结构**复杂**。若要得到有保证的服务，所有的路由器都必须装有RSVP、接纳控制、分类器和调度器。



### 8.4.1 区分服务 DiffServ

#### 1. 区分服务的基本概念

- 由与综合服务IntServ和资源预留协议RSVP都较复杂，很难在大规模的网络中实现，因此ITEF提出了新的策略，即区分服务DiffServ。
- **区分服务**DiffServ(Differentiated Services)有时也简写为**DS**。因此，具有区分服务功能的结点就称为DS结点。

#### 区分服务DiffServ的要点

(1) DiffServ力图不改变网络的基础结构，但在路由器中增加区分服务的功能。

- DiffServ将IPv4协议中原有的服务类型字段和IPv6的通信量类字段定义区分服务字段DS.。路由器根据DS字段的值来转发分组。利用DS字段可提供不同等级的服务质量。
- DS字段现只使用前6bit，即区分服务码点DSCP(Differentiated Services CodePoint)。

(2) 网络被划分为许多个DS域。

- DiffServ将所有的复杂性放在DS域的边界结点(boundary node)中，而使DS域内部路由器工作得尽可能简单。 

(3) 边界路由器中的功能功能较多。

可分为两大部分：

- 分类器(classifier)
- 通信量调节器(conditioner)
  - 标记器(marker)
  - 整形器(shaper)
  - 测定器(meter)

(4) **聚合(aggregation)**

- DiffServ不是为网络中的每一个流持供转发时使用的状态信息，而是将**若干个流根据其DS值聚合成少量的流**。
- 路由器对相同DS值的流都按相同的优先级进行转发。这就大大简化了网络内部的路由器的转发机制。
- 区分服务DiffServ不需要使用RSVP信令。

#### 服务等级协定SLA

- 在使用DS字段之前，互联网的ISP要和用户商定一个**服务等级协定**SLA(Service Level Agreement)。
- 在SLA中指明了被支持的服务类别(可包含吞吐量、分组丢失率、时延和时延抖动、网络的可用性等)和每一类所容许的通信量。



#### 2. 每跳行为PHB(Per-Hop Behavior)

- "**行为**"就是指在转发分组时路由器对分组是怎样处理的。
- "**每跳**"是强调这里所说的行为只涉及到本路由器转发的这一跳行为，而下一个路由器再怎样处理则与本路由器的处理无关。
- 这和IntServ/RSVP考虑的服务质量是“端到端”的很不一样。

##### DiffServ定义的两种PHB

- **迅速转发PBH**，即**EF** PHB，或EF。
- EF指明离开一个路由器的通信量的数据率必须等与或大于某一数值。因此EF PHB用来构造通过DS域的低丢失率、低时延、低时延抖动、确保带宽的端对端服务(即不排队或很少排队)。
- **确保转发**PHB，即AF PHB，或AF。
- AF用DSCP的比特0~2将通信量划分为**四个等级**，并给每一种等级提供最低数量的带宽或缓存空间。
- 对于其中的每一个等级再用DSCP的比特3~5划分出**三个"丢弃优先级"**。
- 当发生网络拥塞时，对于每个等级的AF，路由器**首先把“丢弃优先级”较高的分组丢弃**。