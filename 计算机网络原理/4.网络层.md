# 网络层

## 01概述

### 4.1 网络层提供的两种服务

- 在计算机网络领域，网络层应该向运输层提供怎样的服务（“**面向连接**”还是“**无连接**”）曾引起了长期的争论。
- 争论焦点的实质就是：在计算机通信中，可靠交付应当由谁负责？是**网络**还是**端系统**？

**一种观点：让网络负责可靠交付**

- 这种观点认为，应借助于电信网的成功经验，让网络负责可靠交付，计算机网络应模仿电信网络，使用面向连接的通信方式。
- 通信之前先建立**虚电路**（Virtual Circuit），以保证双方通信所需的一切网络资源。
- 如果再使用可靠传输的网络协议，就可使所发送的分组无差错按序到达终点，不丢失、不重复。

虚电路是逻辑连接

- 虚电路表示这只是一条逻辑上的连接，分组都沿着这条逻辑连接按照存储转发方式传送，而并不是真正建立了一条物理连接。
- 请注意，电路交换的电话通信是先建立了一条真正的连接。
- 因此分组交换的虚连接和电路交换的连接只是类似，但并不完全一样。

**另一种观点：网络提供数据报服务**

- 互联网的先驱者提出了一种崭新的网络设计思路。
- 网络层向上只提供简单**灵活的、无连接的、尽最大努力交付**的**数据报服务**。
- 网络在发送分组时不需要先建立连接。每一个分组（即IP数据报）独立发送，与其前后的分组无关（不进行编号）。
- **网络层不提供服务质量的承诺**。即所传送的分组可能出错、丢失、重复和失序（不按序到达终点），当然也不保证分组传送的时限。

尽最大努力交付

- 由于传输**网络不提供端到端的可靠传输服务**，这就使网络中的路由器可以做得比交简单，而且价格低廉（与电信网的交换机相比较）。
- 如果主机（即段系统）中的进程之间的通信需要是可靠的，那么就由网络的**主机中输层负责可靠交付（包括差错处理、流量控制等）。**
- **采用这种设计思路的好处是**：网络的造价大大降低，运行方式灵活，能够适应多种应用。
- 互联网能够发展到今日的规模，充分证明了当初采用这种设计思路的正确性。

### 4.2 网际协议IP

- 网络协议IP是TCP/IP体系中两个最主要的协议之一
- 与IP协议配套使用的还有三个协议：
  - 地址解析协议ARP（Address Resolution Protocol）
  - 网际控制报文协议ICMP(Internet Control Message Protocol)
  - 网际组管理协议IGMP(Internet Group Management Protocol)
  - ![image-20200429164141543](C:\Users\bo\AppData\Roaming\Typora\typora-user-images\image-20200429164141543.png)

#### 4.2.1 虚拟互连网络

将网络互连并能够互相通信，会遇对许多问题需要解决，如：

- 不同的寻址方案
- 不同的最大分组长度
- 不同的网络接入机制
- 不同的超时控制
- 不同的差错恢复方法
- 不同的状态报告方法
- 不同的用户接入控制
- 不同的服务（面向连接服务和无连接服务）
- 不同的管理与控制方式等

使用一些中间设备进行互连

- 将网络互相连接起来要使用一些中间设备。
- 中间设备又称为**中间系统**或**中继（relay）系统**。
- 有以下五种不同的中间设备
  - 物理层中继系统：**转发器**（repeater）
  - 数据链路层中继系统：**网桥**或**桥接器**（bridge）。
  - 网洛层中继系统:**路由器**( router)。
  - 网桥和路由器的混合物：**桥路器**（brouter)。
  - 网络层以上的中继系统：**网关**（gateway)。

网络互连使用路由器

- 当中继系统是转发器或网桥时，一般并不称之为网络互连，因为这仅仅是把一个网络扩大了，而这仍然是一个网络。
- 网关由于比较复杂，目前使用得较少。
- 网**络互连都是指用路有器进行网络互连和路由选择。**
- 由于历史的原因，许多有关TCP/IP的文献将网络层使用的路由器称为**网关**。

#### 4.2.2 分类的IP地址

在TCP/IP体系中，IP地址是一个基本的概念。

！！！重点

- IP地址及其表示方法
- 常用的三种类别的IP地址

1. IP地址及其表示方法
   - 我们把整个因特网看成为一个单一的、抽象的网络。
   - IP地址就是给每个连接在互联网上的主机（或路由器）分配一个在全世界范围是**唯一的32位的标识符。**
   - IP地址现在由**互联网名字和数字分配机构**ICANN(Internet Corporation for Assigned Names and Numbers)进行分配。

**分类ip地址**

- 将ip地址划分为若干个固定类。
- 每一类地址都由两个固定长度的字段组成，其中一个字段是网络号 net-id，它标志主机（或路由器）所连接到的网络，而另一个字段则是主机号 host-id，它标志该主机（或路由器）。
- 主机号在它前面的网络号所指明的网络范围内必须是唯一的。
- 由此可见，一个IP地址在整个互联网范围内是唯一的。



IP地址的一些重要特点

(1) ip地址是一种分等级的地址结构。

(2) 实际上ip地址是标志一个主机（或路由器）和一条链路的接口。

(3) **用转发器或网桥连接起来的若干个局域网**仍为一 个网络，因此这些局域网具有同样的网络号net-id。

(4) 所有分配的网络号net-id的网络，无论是范围很小的局域网，还是可能覆盖很大地理范围的广域网，都是平等的。

#### 4.2.3 IP地址与硬件地址

- IP地址与硬件地址是不同的地址。
- 从层次的角度看，
  - 硬件地址（或物理地址）是数据链路层和物理层使用的地址。
  - IP地址是网络层和以上的各层使用的地址，是一种逻辑地址（称IP地址是逻辑地址是因为IP地址是用软件实现的）。

#### 4.2.4 地址解析协议ARP

- 通讯时使用了两个地址：
  - IP地址（网络层地址）
  - MAC地址（数据链路层地址）
  
- 地址解析协议ARP要点
  - 不管网络层使用是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用硬件地址。

  - 每一个主机都设有一个ARP高速缓存（ARP cache），里面有所在的局域网上的各主机和路由器的IP地址到硬件地址的映射表。

    ```<IP address; MAC address; TTL>```

    TTL(Time To Live):地址映射有效时间。

  - 当主机A欲向本局域网上的某个主机B发送数据报时，就先在其ARP高速缓存中查看有无主机B的IP地址

    - 如有，就可查出其对应的硬件地址，再将此硬件地址写入MAC帧，然后通过局域网将该MAC帧发往此硬件地址。
    - 如没有，ARP进程在本局域网上广播发送一个ARP请求分组。收到ARP响应分组后，将得到的IP地址到硬件地址映射写入ARP高速缓存。

 - ARP请求分组：包含发送方硬件地址、发送方IP地址、目标方硬件地址（未知时填0）、目标方IP地址。

 - 本地广播ARP请求（路由器不转发ARP请求）。

 - ARP响应分组：包含发送方硬件地址、发送方IP地址、目标方硬件地址、目标方IP地址。

 - ARP分组封装在物理网络的帧中传输。

------------------------

高速缓存的作用

- 存放最近获得的IP地址到MAC地址的绑定，以减少ARP广播的数量。
- 为了减少网络上的通信量，主机A在发送其ARP请求分组时，就将自己的IP地址到硬件地址的映射写入了ARP请求分组。
- 当主机B收到A的ARP请求分组时，就将主机A的这一地址映射写入主机B自己的ARP高速缓存中。这对主机B以后向A发送数据报时就更方便了。

### 应当注意的问题

- ARP是解决**同一个局域网**上的主机或路由器的IP地址和硬件地址的映射问题。
- 如果所要找的主机和源主机不在同一个局域网上，那么就要**通过ARP找到一个位于本局域网上的某个路由器的硬件地址**，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络。剩下的工作就由下一个网络来做。

#### 4.2.5 IP数据报的格式

- 一个IP数据报由首部和数据两部分组成。
- 首部的前一部分是固定长度，共20字节，是所有IP数据报必须具有的。
- 在首部的固定部分的后面是一些可选字段，长度是可变的。



------

IP数据报分片

- 一数据报的总长度为3829字节，其数据部分的长度为3800字节（使用固定首部），需要分片为长度不超过1420字节的数据报片。
- 因固定首部长度为20字节，因此每个数据报片的数据部分长度不能超过1400字节。
- 于是分为3 个数据报片，其数据部分的长度分别为1400、1400和1000字节。
- **原始数据报首部被复制为各数据报片的首部，但必须修改有关字段的值。**

#### 4.2.6 IP层转发分组的流程

- 假设：有四个A类网络通过三个路由器连接在一起。每一个网络上都可能有成千上万个主机。
- 可以想像，**若按目的主机号来制作路由表**，一个路由表就有4万个项目，即4万行（每一行对应于一台主机），则所得出的路由表就过与庞大。
- 但**若按主机所在的网络地址来制作路由表**，那么每一个路由器中的路由表就只包含4个项目（每一行对应于一个网络），这样就可使路由表大大简化。

---

**查找路由表**

**根据目的网络地址**就能确定下一跳路由器，这样做的结果是：

- IP数据报最终一定可以找到目的主机所在目的的网络 上的路由器（可能要通过多次**间接交付**）。
- 只有到达最后一个路由器时，才试图向目的主机进行**直接交付**。

### 4.3 划分子网和构造超网

- 二进制数
  - 1位二进制数：0、1
  - 2位二进制数：00、01、10、11（即0、1、2、3）
  - 3位二进制数：000、001、010、011、100、101、110、111（即1、2、3、4、5、6、7）
  - N位二进制数：2n
  - 二进制数与十进制数关系：
    - ![image-20200430154235753](C:\Users\bo\AppData\Roaming\Typora\typora-user-images\image-20200430154235753.png)
  - 10011001转为十进制数为153
    - ![image-20200430154455238](C:\Users\bo\AppData\Roaming\Typora\typora-user-images\image-20200430154455238.png)

- A类网络

- 网络号（8位）：0 0000000-0 1111111

- 主机号（24位）：

  第一位：00000000 00000000 00000000

  最后位：11111111 11111111 11111111

#### 4.3.1 划分子网

##### 1. 从两级IP地址到三级IP地址

   - 在ARPANET的早期，IP地址的设计确实不够合理：
     - （1）IP地址空间的利用率有时很低。
     - （2）给每一个物理网络分配一个网络号会使路由表变得太大因而使网络性能变坏。
     - （3）两级的IP地址不够灵活。

##### 三级网络

   划分子网的基本思路

   - 划分子网纯属一个**单位内部的事情**。单位对外仍然表现为没有划分子网的网络。

   - 从主机号**借用**若干个位作为**子网号**subnet-id，而主机号host-id也就相应减少了若干个位。

     **IP地值::={<网络号>,<子网号>,<主机号>}**

   - 凡是从其他网络发送给本单位某个主机的IP数据报，仍然是根据IP数据报的**目的网络号**net-id，先找到连接在**本单位网络上的路由器**。

   - 然后**此路由器**在收到IP数据报后，再按**目的网络号**net-id和**子网号**subnet-id找到目的子网。

   划分子网后变成了三级结构

   - 当没有划分子网时，IP地址是两级结构。
   - 划分子网后IP地址就变成了三级结构。。
   - 划分子网只是把IP地址的主机号host-id这部分进行再划分，而不改变IP地址原来的网络号net-id。

###### 划分子网后变成了三级结构

   - 优点
     - 减少了IP地址的浪费
     - 使网络的组织更加灵活
     - 更便于维护和管理
   - 划分子网纯属一个单位内部的事情，对外部网络透明，对外仍然表现为没有划分子网的一个网络。

##### 2. 子网掩码

   - 从一个IP数据报的首部并**无法判断**源主机或目的主机所连接的网络是否进行了子网划分。
   - 使用**子网掩码**（subnet mask）可以找出IP地址中的子网部分。

--------

   规则：

   - 子网掩码长度=32位

   - **某位 =1**：IP地址中的对应位为网络号和子网号

   - **某位=0**：IP地址中的对应位为主机号

     **（IP地址) AND （子网掩码) = 网络地址**

-----

   子网掩码是一个重要属性

   - **子网掩码是一个网络或一个子网的重要属性**。
   - 路由器在和邻路由器交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉相邻路由器
   - 路由器的路由表中的每一个 亲+ ，除了要给出目的网络地址外，还必须同时给出该网络的子网掩码。
   - 若一个路由器连接在两个子网上就拥有两个网络地址和两个子网掩码。

------

   子网划分方法

   - 有**固定长度子网**和**变长子网**两种子网划分方法。

   - **在采用固定长度子网时，所划分的所有子网的子网掩码都是相同的。**

   - 虽然根据已成为互联网标准协议的RFC 950文档，子网号不能为**全1**或**全0**，但随着无分类域间路由选择CIDR的广泛使用，现在全1和全0的子网号也可以使用了，但一定要谨慎使用，确认的你的路由器所用的路由选择软件是否支持全0或全1的子网号这钟较新的用法。

   - **划分子网增加了灵活性，但却减少了能够连接在网络上的主机总数。**

     **不同的子网掩码得出相同的网络地址。但不同的掩码的效果是不同的。**

#### 4.3.2 使用子网是分组的转发

- 在不划分子网的两级IP地址下，从IP地址得出网络地址是个很简单的事。
- 但在划分子网的情况下，从IP地址却不能唯一地得出网络地址来，这是因为网络地址取决于那个网络所采用的子网掩码，但**数据报的首部并没有提供子网掩码的信息**。
- 因次分组转发的算法也必须做相应的改动。

##### 在划分子网情况下路由器转发分组的算法

（1）从收到的分组的首部提取目的IP地址D。

（2）先用各网络的子网掩码和D逐位相“与”，看是否和相应的网络地址匹配。若匹配，则将分组直接交付。否则就是间接交付，执行（3）。

（3）若路由表中有目的地址为D的特定主机路由，则将分组传送给指明的下一跳路由器;否则，执行（4）。

（4）对路由表中的每一行，将子网掩码和D逐位相“与”。若结果与该行的目的网络地址匹配，则将分组传送给该行指明的下一跳路由器;否则，执行（5）。

（5）若路由表中有一 个默认路由，则将分组传送给路由表中所指明的默认路由器;否则，执行（6).

（6）报告转发分组出错。

#### 4.3.3 无分类编址CIDR（构造超网）

##### 1.网络前缀

划分子网在一定程度上缓解了互联网在发展中遇到的困难。然而在1992年互联网仍然面临三个必须尽早解决的问题：

- (1) B类地址在1992年已分配了近一半，眼看接要在1994年3月全部分配完毕！
- (2) 互联网主干网上的路由表中的项目数急剧增长（从几千个增长到几万个）。
- (3) 整个IPv4的地址空间最终将全部耗尽。

##### IP编址问题的演进

- 1987年，RFC 1009 就指明了在一个划分子网的网络中可同时使用几个不同的子网掩码。
- 使用变长子网掩码VLSM(Variable Length Subnet Mask)可进一步提高IP地址资源利用的利用率。
- 在VLSM的基础上又进一步研究出无分类编址方法，它的正式名字是**无分类域间路由选择CIDR(Classsless Inter-Domain Routing)**。

##### CIDR最主要的特点

- CIDR消除了传统的A类、B类和C类地址以及划分子网的概念，因而可以更加有效的分配IPv4d的地址空间。
- CIDR使用各种长度的“**网络前缀**“(network-prefix)来代替分类地址中的网络号和子网号。
- IP地址从三级编址（使用子网掩码）又回到了两级编址。

###### 无分类的两级编址

- 无分类的两级编址的记法是：

  网络前缀|主机号 **共32位**

  **IP地址::={<网络前缀>,<主机号>}**

- CIDR使用“斜线记法”(slash notation)，它又称为CIDR记法，即在IP地址面加上一个斜线“/“，然后写上网络前缀所占的位数（这个数值对应于三级编址中子网掩码中1的个数）。例如：220.78.168.0、24

##### CIDR地址块  

- CIDR把网络前缀都相同的连续的IP地址组成“CIDR地址块”。
- 128.14.32.0/20表示的地址块共有2^12个地址（因为斜线后面的20是网络前缀的位数，所以这个地址的主机号是12位）
  - 这个地址块的起始地址是128.14.32.0。
  - 在不需要的指出地址块的起始地址时，也可将这样的地址块简称为“/20地址块“。
  - 128.14.32.0/20 地址块的最小地址：128.14.32.0
  - 128.14.32.0/20 地址块的最大地址：128.14.47.255
  - **全0和全1的主机号地址一般不使用。**

##### 路由聚合(route aggregation)

- 一个CIDR地址块可以表示很多地址，这种地址的聚合常称为**路由聚合**，它使得路由表中的一个项目可以表示很多个（例如上千个）原来传统分类地址的路由。
- 路由聚合有利于**减少**路由器之间的路由选择信息的交换，从而提高了整个互联网的性能。
- **路由聚合也称为构成超网(supernetting)**。
- CIDR虽然不使用子网了，但仍然使用“掩码”这一名词（但不叫子网掩码）。
- 对于/20地址块，它的掩码是20个连续的1。斜线记法中的数字就是掩码中1的个数。

##### CIDR记法的其他形式

- 10.0.0.0/10可简写为10/10，也就是把点分十进制中低位连续的0省略。
- 10.0.0.0/10 隐含的指出IP地址10.0.0.0的掩码是255.192.0.0。此掩码可表示为：
  - 11111111 11000000 00000000 00000000
- 网络前缀的后面加一个星号*的表示方法， 如00001010 00*，在星号，之前是网络前缀，而星号*表示IP地址中的主机号，可以是任意值。

##### 构成超网

- 前缀长度不超过23位的CIDR地址块都包含了多个C类地址。

- 这些C类地址合起来就构成了超网。

- **CIDR地址块中的地址数一定是2的整数次幂。**

- 网络前缀越短，其地址块所包含的地址数就越多。**而在三级结构的IP地址中，划分子网是使用网络前缀变长。**

- CIDR的一个好处是：可以更加有效的分配IPv4的地址空间，可根据客户的需要分配适当的大小的CIDR地址块。

  **这个ISP共有64个C类网络。如果不采用CIDR技术，则在与该ISP的路由器交换路由信息的每一个路由器的路由表中，就需要有64个项目。但采用地址聚合后，只需用路由聚合后的1个项目206.0.64.0/18就能找到该ISP。**

##### 2. 最长前缀匹配

- 使用CIDR时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成。**在查找路由表时可能会得到不止一个匹配结果。**
- 应当从匹配结果中选择具有最长网络前缀的路由：**最长前缀匹配**(longest-prefix matching)。
- 网络前缀越长，其地址块就越小，因而路由就越具体(more specific)。
- 最长前缀匹配又称为**最长匹配**或**最佳匹配**

### 4.4 网际控制报文协议ICMP

- 为了更有效的转发IP数据报和提高交付成功的机会，在网际层使用了网际控制报文协议ICMP(Internet Control Message Protocol)。
- ICMP是互联网的标准协议。
- ICMP允许主机或路由器报告差错情况和提供有关异常情况的报告。
- 但ICMP不是高层协议（看起来好像是高层协议，因为ICMP报文是装在IP数据报中，作为其中的数据部分），而是IP层的协议。

#### - 4.4.1 ICMP报文的种类

- ICMP报文的种类有两种，即ICMP**差错报告报文**和ICMP**询问报文**。
- ICMP报文的前4个字节是统一的格式，共有三个字段：即**类型**、**代码**和**检验和**。接着的4个字节的内容与ICMP的类型有关。

##### 差错报告报文共有4种

- 终点不可达
- 时间超过
- 参数问题
- 改变路由（重定向）(Redirect)

##### 不应发送ICMP差错报告的几种情况

- 对ICMP差错报告报文不再发送ICMP差错报告报文。
- 对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文。
- 对具有多播地址的数据报都不发送ICMP差错报告报文。
- 对具有特殊地址（如127.0.0.0或0.0.0.0）的数据报不发送ICMP差错报告报文。

##### ICMP询问报文有两种

- 回送请求和回答报文
- 时间错请求和回答报文

##### 下面的几种ICMP报文不再使用;

- 信息请求与回答报文
- 掩码地址请求和回答报文
- 路由器询文报文和通告报文
- 源点抑制报文

#### - 4.4.2 ICMP的应用举例

**PING（Packet InterNet Groper）**

- PING用来测试两个主机之间的连通性。
- PING使用了ICMP回送请求与回送回答报文。
- PING是应用层直接使用网络层ICMP的例子，它没有通过运输层的TCP或UDP。

**Traceroute的应用举例**

- 在Windows操作系统中这个命令是tracert。
- 用来跟踪一个分组从源点到终点的路径。
- 它利用IP数据报中的TTL字段和ICMP时间超过差错报告报文实现对从源点到终点的路径的跟踪。

### 4.5 互联网的路由选择协议

#### 4.5.1 有关路由选择协议的几个基本概念

##### 1.理想的路由算法

- 算法必须是正确的和完整的。
- 算法在计算上应简单。
- 算法应能适应通信量和网络拓扑的变化，这就是说，要有自适应性。
- 算法应具有稳定性。
- 算法应是公平的。
- 算法应是最佳的。

##### 关于“最佳路由”

- 不存在一种绝对的最佳路由算法。
- **所谓“最佳”只能是相对于某一种特定的要求下得出的较为合理的选择而已**。
- 实际的路由选择算法，应尽可能接近于理想的算法。
- 路由选择是个非常复杂的问题
  - **它是网络中的所有结点共同协调工作的结果**。
  - **路由选择的环境往往是不断变化的，而这种变化有时无法事先知道**。

##### 从路由算法的自适应性考虑

- **静态**路由选择策略——即**非自适应路由选择**，其特点是简单和开销较小，但不能及时适应网络状态的变化。
- **动态**路由选择策略——即**自适应路由选择**，其特点是能较好的适应网络状态的变化，但实现起来较为复杂，可销也比较大。

##### 2. 分层次的路由选择协议

- **互联网采用分层次的路由选择协议**。这是因为:
  - (1) 互联网的规模非常大。如果让所有的路由器知道所有的网络应怎样到达，则这种路由表将非常大，处理起来也太花时间。而所有这些路由器之间交换路由信息所需的带宽就会使互连网的通信链路饱和。
  - (2) 许多单位不愿意外界了解自己单位网络的布局细节和本部门所采用的路由择协议（这属于本部门内部的事情），但同时还希望连接对互联网上。

##### 自治系统AS （Autonomous System）

- **自治系统AS的定义**：在单一的技术管理下的一组路由器，而这些路由器使用一种AS内部的路由选择协议和共同的度量以确定分组在该AS内的路由，同时还使用一种AS之间选择协议用以确定分组在AS之间的路由。
- 现在对自治系统AS的定义是强调下面的事实：尽管一个AS使用了多种内部路由选择协议和度量，但**重要的是一个AS对其他AS表现出的是一个单一的和一致的路由选择策略。**

##### 互联网有两大类路由选择协议

- **内部网关协议I**GP(Interior Gateway Protocol) (具体的协议有多种，如RIP和OSPF等。)
  - 在一个自治系统内部使用的路由选择协议。
  - 目前这类路由选择协议使用得最多，如RIP和OSPF协议。

- **外部网关协议**EGP(External Gateway Protocol) (目前使用的协议就是BGP。)

  - 若源站和目的站处在不同的自治系统中，当数据报传到一个自治系统的边界时，就需要使用一种协议**将路由选择信息传递到另一个自治系统中**。这样的协议就是外部网关协议EGP。

  - 在外部网关协议中目前使用最多的是BGP-4。

    **自治系统之间的路由选择也叫做域间路由选择(interdomain routing)，在自治系统内部的路由选择叫做域内路由选择**



#### 4.5.2 内部网关协议 RIP

##### 1.工作原理

- 路由信息协议RIP(Routing Information Protocol)是内部网关协议IGP中最先得到广泛使用的协议。
- RIP是一种**分布式的、基于距离向量的路由选择协议**。
- **RIP协议要求**网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录。

###### “距离”的定义

- 从一个路由器到**直接连接**的网络的距离定义为1。
- 从一个路由器到非直接连接的网络的距离定义为所经过的路由器数加1。
- RIP协议中的“距离”也称为“**跳数**”(hopcount)，因为每经过一个路由器，跳数就加1.
- 这里的“距离”实际上指的是“**最短距离**”。
- RIP认为一个**好的路由**就是它通过的路由器的数目少，即”**距离短**“。
- **RIP允许一条路径最多只能包含15个路由器**。
- **“距离”的最大值为16时即相当于不可达**。可见RIP只适用于小型互联网。
- **RIP不能在两个网络之间同时使用多条路由**。RIP选择一个具有最少路由器的路由（即最短路由）。哪怕还存在另一条高速（低时延）但路由器比较多的路由。

###### RIP协议的三个特点

- (1) 仅和**相邻路由器**交换信息。
- (2) 交换的信息是当前本路由器所知道的**全部信息，即自己的路由表**。 
- (3) 按固定的时间间隔**交换路由信息**，例如，每隔30秒。当网络拓扑发生变化时，路由器也及时向相邻路由器通告拓扑变化后的路由信息。

###### 路由表的建立

- 路由器在**刚刚开始工作**时，只知道直接接的网络的距离（此距离定义为1）。她的**路由表是空的**。
- 以后，每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息。
- 经过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址。

##### 2. 距离向量算法

路由器收到相邻路由器（其地址为X）的一个RIP报文：

(1) 先修改此RIP报文中的所有项目：把“下一跳”字段中的地址都改为X，并把所有的“距离“字段的值加1.

(2)对修改后的RIP报文中的每一个项目，重复以下步骤：

​	若项目中的目的网络不在路由表中，则把该项目加到路由表中。

​	否则（若下一跳字段给出的路由器地址是同样的，则把收到的项目替换原路由表中的项目。

​	否则（若收到项目中的距离小于路由表中的距离，则进行更新，

​	否则，什么也不做。

(3) 若3分钟还没有收到相邻路由器的更新路由表，则把此相邻路由器记为不可达路由器，即将距离置为16（表示不可达）。

(4) 返回。

- 距离向量算法的基础就是Bellman-Ford算法(或Ford-Fulkerson算法)。

- 这种算法的**要点**是这样的：

  设X是结点A到B的最短路径上的一个结点。若把路径A-->B拆成两段路径A—>X和X—>B,则每一段路径A—>X的X—>B也都分别是结点A到结点X到B的最短路径。

###### 路由器之间交换信息与路由表更新

- RIP协议让互联网中的所有路由器都和自己的相邻路由器不断交换路由信息，并不断更新其路由表，使得从每一个路由器到每一个目的网络的路由都是最短的（即跳数最少）。
- 虽然所有的路由器最终都拥有了整个自治系统的全局路由信息，但由于每一个路由器的位置不同，它们的路由表当然也应当是不同的。

###### 好消息传播的快，坏消息传播得很慢

- **RIP协议特点**：好消息传播得快，坏消息传播的慢。
- **RIP存在一个问题**：当网络出现故障时，要经过比较长的时间（例如数分钟）才能将此信息传送到所有的路由器。

###### RIP协议的优缺点

- 优点：
  - 实现简单，开销较小。
- 缺点：
  - RIP限制了网络的规模，他能使用的最大距离为15（16表示不可达）。
  - 路由器之间交换的路由消息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加。
  - “坏消息传播得慢”，使更新过程的收敛时间过长。

#### 4.5.3 内部网关协议 OSPF

#### 4.5.4 外部网关协议 BGP 

#### 4.5.5 路由器的构成

- 路由器是一种典型的网络层设备。
- 路由器是互联网中的关键设备。
- 路由器的主要作用是：
  - 连通不同的网络。
  - 选择信息传送的线路。选择通畅快捷的近路，能大大提高通信速度，减轻网络系统通信负荷，节约网络系统资源，提高网络系统畅通率，从而让网络系统发挥出更大的效益来。

##### 1. 路由器的结构

- 路由器是一种具有多个输入端口和多个输出段口的专用计算机，其任务是转发分组。也就是说，将路由器某个输入端口收到的分组，按照分组要去的目的地（即目的网络），把该分组中路由器的某个合适的输出端口转发给下一跳路由器。
- 下一跳路由器也按照这种方法处理分组，直到该分组到达终点为止。
- 路由器的转发分组正是网络层的主要工作。

###### 典型的路由器的结构

- 整个的路由器结构可划分为两大部分：
  - 路由选择部分
  - 分组转发部分
- 路由选择部分
  - 也叫做控制部分，其核心构件是路由选择处理机。
  - 路由选择处理机的任务是根据所选定的路由选择协议构造出路由表，同时经常或定期地相邻路由器交换路由信息而不断的更新和维护路由表。
- 分组转发部分由三部分组成：
  - 交换结构(switching fabric)：又称为交换组织，其作用是根据转发表(forwarding table)对分组进行处理。
  - 一组输入端口
  - 一组输出端口。（端口即硬件接口）

###### 输入端口对线路上收到的分组的处理

- 路由器的输入端口里面装有物理层、数据链路层和网络层的处理模块。
- 数据链路层剥去帧首部和尾部后，将分组送到网络层的队列中排队等待处理。这会产生一定的时延。
- **输入端口中的查找和转发功能在路由器的交换功能中是最重要的。**

###### “转发”和“路由选择”的区别

- “转发”(forwarding) 就是路由器根据转发表将用户的IP数据报从合适的端口转发出去。
- “路由选择”(routing) 则是按照分布式算法，根据中各相邻路由器得到的关于网络拓扑的变话情况，动态的改变所选择的路由。
- **路由表是根据路由选择算法得出的。而转发表是从路由表得出的。**
- 在讨论路由选择的原理时，往往不去区分转发表的路由表的区别。

###### 输出端口将交换结构传送来的分组发送到线路

- 输出端口里面装有物理层、数据链路层和网络层的处理模块。
- 输出端口从交换结构接收分组，然后把它们发送到路由器外面的线路上。
- 在网络层的处理模块中设有一个缓冲区（对列）。当交换结构传送过来的分组的速率超过输出链路的发送速率时，来不及发送的分组就必须暂时存放在这个队列中。
- 数据链路层处理模块将分组加上链路层的首部和尾部，交给物理层后发送到外部线路。

###### 分组丢弃

- 若路由器处理分组的速率赶不上分组进入队列的速率，则队列的存储空间最终必定减少到零，这就使后面再进入队列的分组由于没有存储空间而只能被丢弃。
- **路由器中的输入或输出队列产生溢出是造成分组丢失的重要原因。**

##### 2.交换结构

- 交换结构是路由器的关键构件
- 正是这个交换结构把分组从一个输入端口转移到某个合适的输出端口。
- 实现交换有多种方法。常用交换方法有三种：
  - 通过存储器
    - 当路由器的某个输入端口收到一个分组时，就用中断方式通知路由选择处理机。然后分组就从输入端口复制到存储器中。
    - 路由器处理机从分组首部提取目的地址，查找路由表，再将分组复制到合适的输出端口的缓存中。
    - 若存储器的带宽（读或写）为每秒M个分组，那么路由器的交换速率（即分组从输入端口传送到输出端口的速率）一定小于M/2。
  - 通过总线
    - 数据报从输入端口通过共享的总线直接传送到合适的输出端口，而不需要路由选择处理机的干预。
    - 因为每一个要转发的分组都要通过这一条总线，因此路由器的转发带宽就受总线速率的限制。
    - 现代的技术已经可以将总线的带宽提高到每秒吉比特的速率，因此许多的路由器产品都采用这种通过总线的交换方式。
  - 通过纵横交换结构

## 02物理层—设备（网络）之间如何连接以及链接媒介

## 03数据链路层-控制数据如何在链路上传输

## 04网络层-路由选择与通信 重点

## 05运输层-两个主机之间的数据传输服务

## 06层-应用服务及相关协议

## 07安全-网络面临的威胁与应对

## 08互联网上的音视频服务

## 09无线网络

