# 数据链路层

数据链路层使用的信道主要有以下的两种类型：

- 点对点信道。这种信道使用一对一的点对点通信方式。
- 广播信道。这种信道使用一对多的广播通信方式，因此过程比较复杂。广播信道上连接的主机很多，，因次必须使用专用的共享信道协议来协调这些主机的数据发送。

## 3.1 使用点对点信道的数据链路层

### 3.1.1 数据链路和帧

- **链路**(link)是一条无源的点到点的物理结构，中间没有任何其他的交换结点。
  - **一条链路只是一条通路的一个组成部分。**
- **数据链路**(data link)除了物理线路外，还必须有通信协议来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。
  - 现在最常用的方法是使用适配器（即网卡）来实现这些协议的硬件和软件。
  - 一般的适配器都包括了数据链路层和物理层这两层的功能。
- 也有人采用另外的术语。这就是把链路分为物理链路和逻辑链路。
- **物理链路**就是上面所说的链路。
- **逻辑链路**就是上面的数据链路，是物理链路加上必要的**通讯协议**。
- 早期的数据通信协议曾叫做通信规程(procedure)。因此在数据链路层，规程和协议是同义语。

数据链路层传送的是帧

#### 数据链路层像个数字管道

- 常常在两个对等的数据链路层之间画出一个数字管道，而在这条数字管道上传输的数据单位是帧。
- 数据链路层不必考虑物理层如何实现比特传输的细节。甚至还可以更简单的设想好像是沿着两个数据链路层之间的水平方向把帧直接发送个对方。

### 3.1.2 三个基本问题

- 数据链路层协议有许多种，但有三个基本问题则是共同的。这**三个基本**问题是：

1. 封装成帧 ：
- 就是在一段数据的前后分别添加首部和尾部，然后就构成了一个帧。确定帧的界限
- 首部和尾部的一个重要作用就是要进行**帧定界**。

#### 用控制字符进行帧定界的方法

- 当数据是由可打印的ASCII码组成的文本文件时，帧定界可以使用特殊的帧定界符。
- 控制字符SOH(Start Of Header)放在一帧的最前面表示帧的首部开始。另一个控制字符EOT(End Of Transmission)表示帧的结束。

2. 透明传输

- 如果数据中的某个字节的二进制代码恰好和SOH或EOT一样，数据链路层就会错误地“找到帧的边界“

#### 解决透明传输问题

- 解决方法：**字节填充**(byte stuffing)或**字符填充**(character stuffing)
- 发送端的数据链路层在数据层中出现控制字符“SOH”或“EOT”的前面**插入一个转义字符“ESC**（其十六进制边码是1B）”。
- 接收端是数据链路层在将数据送往网络层之前删除插入的转义字符。
- 如果转义字符也出现在数据当中，那么应在转义字符前面插入一个转义字符ESC。当接收端收到连续两个转义字符时，就删除其中前面的一个。

3. 差错控制

- 在传输过程中可能会产生**比特差错**：1可能会变成0而0也可能变成1.
- 在一段时间内，传输错误的比特占所传输比特总数的比率称为**误码率BEF(Bit Error Rate)**。
- 误码率与信噪比有很大的关系。
- 为了保证数据传输的可靠性，在计算机网络传输数据时，必须采用各种差错检测措施

#### 循环余检验的原理

- 在数据链路层传送的帧中，广泛使用了循环用余CRC的检错技术。
- 在发送端，先把数据划分为组。假定每组k个比特。
- 假设待传送的一组数据M=101001(现用k=6)。我们在M的后面再添加供差错检测用的n位用余码一起发送。

## 3.2 点对点协议PPP

### 3.2.1 PPP协议的特点

- 对于点对点的链路，目前使用得最广泛的数据链路层协议是点对点协议PPP(Point-to-Point Protocol)。
- 用户使用拨号电话线接入互联网时，用户计算机和ISP进行通信时所使用的数据链路层协议就是PPP协议
- PPP协议在1994年就已成为互联网的正式标准。

#### 1.PPP协议应满足的需求

- 简单——首要的要求。
- 封装成帧——必须规定特殊的字符作为帧定界符。
- 透明性——必须保证数据传输的透明性。
- 多种网络协议——能够在同一条物理链路上同时支持多种网络协议。
- 多种类型链路——能够在多种类型的链路上运行。
- 差错检测——能够对接收端收到的帧进行检测，并立即丢弃有差错的帧。
- 检测连接状态——能够及时自动检测出链路是否处于正常工作状态。
- 最大传送单元——必须对每一种类型的点对点链路设置最大传送单元 MTU的标准默认值，促进各种实现之间的互操作性。
- 网络层地址协商——必须提供一种机制使通信的两个网络层实体能够通过协商知道或能够配置彼此的网络层地址。
- 数据压缩协商——必须提供一种方法协商使用数据压缩算法。

#### 2. PPP协议不需要的功能

- 纠错
- 流量控制
- 序号
- 多点线路
- 半双工或单工链路

#### 3.PPP协议的组成

- PPP协议有三个组成部分
  - 1.一个IP数据报封到串行链路的方法。
  - 2.链路控制协议LCP(Link Control Protocol)
  - 3.网络控制协议NCP(Network Control Protocol)

### 3.2.2 PPP协议的帧格式

- PPP帧的首部和尾部分别为4个字段和2个字段。
- 标志字段F=0x7E（符号“0x"表示后面的字符是用十六进制表示。十六进制的7E的二进制表示是01111110）”。
- 地址字段A只置为0xFF。地址字段实际上并不起作用
- 控制字段C通常置为0x03.
- PPP是面向字节的，所有的PPP帧的长度都是整数字节。

#### 透明传输问题

- 当PPP用在同步传输链路时，协议规定采用硬件来完成比特填充(和HDLC的做法一样)。
- 当PPP用在异步传输时，就使用一种特殊的字符填充法。
  - 字符填充
    - 将信息字段中出现的每一个0x7E字节转变成为2字节序列(0x7D,0x5E)。
    - 若信息字段中出现一个0x7D的字节，则将其转变成为2字节序列(0x7D,0x5D)。
    - 若信息字段中出现ASCII码的控制字符（即数值小于0x20的字符），则在该字符前面要加入一个0x7D字节，同时将该字符的编码加以改变。
  - 零比特填充
    - PPP协议用在SONET/SDH链路时，使用同步传输（一连串的比特连续传送）。这时PPP协议采用零比特填充方法来实现透明传输。
    -  在发送端，只要发现有5个连续1，则立即填入一个0。
    - 接收端对帧中的比特流进行扫描。每当发现5个连续1时，就把这5个连续1后的一个0删除。

#### 不提供使用序号和确认的可靠传输

- PPP协议之所以不使用序号和确认机制是出于以下考虑：
  - 在数据链路层出现差错的概率不大时，使用比较简单的PPP协议较为合理。
  - 在因特网环境下，PPP的信息字段放入的数据是IP数据报。数据链路层的可靠传输并不能够保证网络层的传输也是可靠的。
  - 帧检验序列FCS字段可保证无差错接受。

### 3.2.3 PPP协议的工作状态

- 当用户拨号接入ISP时，路由器的调制解调器对拨号做出确认，并建立一条物理连接。

- PC机向路由器发送一系列的LCP分组（封装成多个PPP帧。
- 这些分组及其响应选择一些PPP参数，并进行网络层配置NCP给新接入的pc主机分配一个临时的IP地址，使PC机成为因特网上的一个主机。
- 通信完毕时，NCP释放网络层连接，收回原来分配出去的IP地址。接着，LCP释放网络链路层链接。最后释放的是物理层的连接
- **可见，ppp协议已不是纯粹的数据链路层的协议，它还包含了物理层和内用层的内容**

### 3.3 使用广播信道是数据链路层

#### 3.3.1 局域网的数据链路层

- 局域网最主要的**特点**是：
  - 网络为一个单位所拥有;
  - 地理范围和站点数目均有限。
- 局域网具有如下**主要优点**：
  - 具有广播功能，从一个站点可很方便的访问全网。局域网上的主机可共享连接在局域网上的各种硬件和软件资源。
  - 便于系统的扩展和逐渐的演变，各设备的位置可灵活调整和改变。
  - 提高了系统的可靠性、可用性和残存性。

1.以太网的两个标准

- DIX Ethernet V2是世界上第一个局域网产品（以太网）的规约。
- IEEE 802.3 是第一个IEEE的以太网标准。
- DIX Ethernet V2标准与IEEE的802.3标准只有很小的差别，因此可以将802.3局域网简称为“以太网”。



#### 数据链路层的两个子层

- 为了使数据链路层能更好地适应多种局域网标准，IEEE802委员会就将局域网的数据链路层拆成两个子层：
  - **逻辑链路控制LLC**(Logical Link Control)子层;
  - **媒体接入控制MAC**(Medium Access Control)子层。
- 与接入到传输**媒体有关**的内容都放在**MAC**子层，而LLC子层与传输媒体无关。
- 不关采用何种协议的局域网，对**LLC**子层来说都是透明的。

#### 3.3.2网络适配器

#### 适配器的作用

- 网络接口板又称为**通信适配器**(adapter)或**网络接口卡**NIC(Network Interface Card),或“**网卡**”。
- 适配器的重要功能：
  - 进形串行/并行转换。
  - 对数据进行缓存。
  - 在计算机的操作系统安装设备驱动程序。
  - 实现以太网协议。

#### 3.3.2 CSMA/CD协议

- 最初的以太网是将许多计算机都连接到一根总线上。当初认为这样的连接方法即简单又可靠，因为总线上没有有源器件。

以太网采用广播方式发送

- 总线上的每一个工作的计算机都能检测到B发送的数据信号。
- 由于只有计算机D的地址与数据帧首部写入的地址一致，因此只有D才接收这个数据帧。
- 其他所有的计算机（A,C和E）都检测到不是发送给它们的数据帧，因此就丢弃这个数据帧而不能够接收下来。
- 在具有广播特性的总线上实现了一对一的通信。

以太网采取了两种重要的措施

为了通信的简便，以太网采取了两种重要的措施

（1）采用了较为灵活的无连接的工作方式

- 不必先建立连接就可以直接发送数据。
- 对发送的数据帧不进行编号，也不要求对方发回确认。
- **这样做的理由是局域网信道的质量很好，因信道质量产生差错的概率是很小的**。

####　以太网提供的服务

- 以太网提供的服务是不可靠的交付，即尽最大努力的交付。

- 当目的站收到有差错的数据帧时就丢弃此帧，其他什么也不做。差错的纠正由高层来决定。
- 如果高层发现丢失了一些数据而进行重传，但以太网并不知道这是一个重传的帧，而是当作一个新的数据帧来发送。

（2）以太网发送的数据都使用曼彻斯特(Manchester)编码

曼彻斯特编码缺点是：它所占的频带宽度比原始的基带信号增加了一倍。



CSMA/CD协议

- CSMA/CD含义：载波监听多点接入、碰撞检测(Carrier Sense Multiple Access With Collision Detection)。
- “多点接入”表示许多计算机以多点接入的方式连接在一根总线上。
- “载波监听”是指每一个站在发送数据之前先要检测一下总线上是否有其他计算机在发送数据，如果有，则暂时不要发送数据，以免发生碰撞。
  - 碰撞检测
    - “碰撞检测”就是计算机边发送数据边检测信道上的信号电压大小。
    - 当几个站同时在总线上发送数据时，总线上的信号电压摆动值将会增大（互相叠加）。
    - 当一个站检测到信号电压摆动值超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞。
    - **所谓“碰撞”就是发生了冲突。因此“碰撞检测”也称为“冲突检测”**。
  - 检测对碰撞后
    - 在发生碰撞时，总线上传输的信号产生了严重的失真，无法从中恢复出有用的信息来。
    - **每一个正在发送数据的站，一旦发现总线上出现了碰撞，就要立即停止发送，免得继续浪费网络资源，然后等待一段随机时间后再次发送**

为什么要进行碰撞检测？

- 由于电磁波在总线上的传播速率是有限的，当某个站监听到总线是空闲时，也可能总线并非真正是空闲的。
- A向B发出的信息，要经过一定的时间后才能传送到B。
- B若在A发送的信息到达B之前发送自己的帧（因为这时B的载波检测不到A所发送的信息），则必然要在某个时间和A发送的帧发生碰撞。
- 碰撞的结果是两个帧都变得无用。
- 所以需要在发送期间进行碰撞检测，以检测冲突。

#### CSMA/CD重要特性

- 使用CSMA/CD协议的以太网不能进行全双工通信而**只能进行双向交替通信（半双工通信）**。
- 每个站在发送数据之后的一段时间内，存在着遭遇碰撞的可能性。
- 这种**发送的不确定性**使整个以太网的平均通信量远小于以太网的最高数据率。

#### 争用期

- 最先发送数据帧的站，在发送数据帧后至多经过时间2∏（两倍的端对端往返时延）就可知道发送的数据帧是否遭受了碰撞。
- 以太网的端到端往返时延2∏称为争用期，或碰撞窗口。
- 经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞。

#### CSMA/CD协议的要点

1. 准备发送。但在发送之前，必须先检测信道。
2. 检测信道。若检测到信道忙，则应不停的检测，一直等待信道转为空闲。若检测到信道空闲，并在96比特时间内信道保持空闲（保证了帧间最小间隔），就发送这个帧。
3. 检查碰撞。在发送过程中仍不停的检测信道，即网络适配器要边发送边监听。这里只有两种可能性：
   - 发送成功：在争用期内一直未检测到碰撞。这个肯定能够发送成功。发送完毕后，其他什么也不做。然后回到1。
   - 发送失败：在争用期检测到碰撞。这时立即停止发送数据，并按规定发送人为干扰信号。适配器接着就执行指数退避算法，等r倍512比特时间后，返回步骤2，继续检测信道。但若重传达16次仍不能成功，则停止重传而向上报错。

### 3.3.3 以太网的MAC层

重点介绍：

#### 1.MAC层的硬件地址

  - 在局域网中，**硬件地址**又称为**物理地址**，或**MAC地址**。

  - 802标准所说的“地址”严格的讲应当是每一个站的“名字”或标识符。

  - 但鉴于大家都早已习惯了将这种48位的“名字”称为“地址”，所以本书也采用这种习惯用法，尽管这种说法并不太严格。

    **请注意，如果连接在局域网上的主机或路由器安装有多个适配器，那么这样的主机或路由器就有多个“地址”。更准确些说，这种48位“地址”应当是某个接口的标识符**

！！！ **48位的MAC地址**

- IEEE802标准规定MAC地址字段可采用6字节（48位）或2字节（16位）这两种的一种。
- IEEE的注册管理机构RA负责向厂分配地址字段6个字节的前三个字节（即高位24位），称为组织唯一标识符。
- 地址字段6个字节中的后三个字节（即低位24位）由厂家自行指派，称为扩展唯一标识符，必须保证生产出适配器没有重复地址。

#### 2.MAC帧的格式

- 常用的以太网MAC帧格式有两种标准：
  - **DIX Ethernet V2标准**
  - **IEEE的802.3标准**
- 最常用的MAC帧是**以太网V2的格式**。

**无效的MAC帧**

- 数据字段的长度与长度字段的值不一致。

- 帧的长度不是整数个字节;

- 用收到的帧检验序列FCS查出有差错;

- 数据字段的长度不在46~1500字节之间

- 有效的MAC帧长度为64~1518字节之间

  **对于检查出无效MAC帧就简单地丢弃。以太网不负责重传丢弃的帧。**

**IEEE 802.3MAC帧格式**

与以太网V2 MAC帧格式相似，区别在于：

- （1）IEEE 802.3规定的MAC帧的第三个字段是“长度、类型”。
  - 当这个字段值大于0x0600时（时当于十进制的1536），就表示“类型”。这样的帧和以太网V2 MAC帧完全一样。
  - 当这个字段值小于0x0600时才表示“长度“。
- （2）当“长度、类型”字段值小于0x0600时，数据字段必须装入上面的逻辑链路控制LLC子层的LLC帧。

**现在市场上流行的都是以太网V2的MAC帧，但大家也常常把它称为IEEE 802.3标准的MAC帧**

